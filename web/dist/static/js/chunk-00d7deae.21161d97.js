(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-00d7deae"],{"23ba":function(e,t,a){"use strict";a.d(t,"c",function(){return i}),a.d(t,"d",function(){return n}),a.d(t,"a",function(){return l}),a.d(t,"b",function(){return s}),a.d(t,"e",function(){return c});var o=a("cebc"),r=a("b775");function i(e){return Object(r["a"])({url:"/group/getList",method:"get",params:Object(o["a"])({},e)})}function n(){return Object(r["a"])({url:"/group/getOption",method:"get"})}function l(e){return Object(r["a"])({url:"/group/add",method:"post",data:e})}function s(e){return Object(r["a"])({url:"/group/edit",method:"post",data:e})}function c(e){return Object(r["a"])({url:"/group/remove",method:"delete",data:{id:e}})}},"3ea3":function(e,t,a){"use strict";var o=a("e21b"),r=a.n(o);r.a},"9b7a":function(e,t,a){"use strict";a.r(t);var o=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("el-row",{staticClass:"app-container"},[a("el-row",{staticClass:"app-bar",attrs:{type:"flex"}},[a("el-select",{attrs:{placeholder:"选择分组"},on:{change:e.handleGroupChange},model:{value:e.groupId,callback:function(t){e.groupId=t},expression:"groupId"}},[a("el-option",{attrs:{label:"默认",value:0}}),e._v(" "),e._l(e.groupOption,function(e,t){return a("el-option",{key:t,attrs:{label:e.name,value:e.id}})})],2),e._v(" "),a("el-input",{staticStyle:{width:"300px"},attrs:{placeholder:"请输入项目名称"},on:{change:e.getList},model:{value:e.projectName,callback:function(t){e.projectName=t},expression:"projectName"}})],1),e._v(" "),a("el-table",{staticStyle:{width:"100%"},attrs:{border:"",stripe:"","highlight-current-row":"",data:e.tableData}},[a("el-table-column",{attrs:{prop:"id",label:"ID",width:"160"}}),e._v(" "),a("el-table-column",{attrs:{prop:"name",label:"项目名称"}}),e._v(" "),a("el-table-column",{attrs:{prop:"group",label:"分组"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v("\n        "+e._s(e.findGroupName(t.row.groupId))+"\n      ")]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"environment",label:"环境"}}),e._v(" "),a("el-table-column",{attrs:{prop:"branch",label:"分支"}}),e._v(" "),a("el-table-column",{attrs:{prop:"publisherName",label:"构建者",width:"160"}}),e._v(" "),a("el-table-column",{attrs:{prop:"publishState",label:"状态",width:"60"},scopedSlots:e._u([{key:"default",fn:function(t){return[1===t.row.publishState?a("el-tag",{attrs:{type:"success",effect:"plain"}},[e._v("成功")]):a("el-tag",{attrs:{type:"danger",effect:"plain"}},[e._v("失败")])]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"updateTime",label:"上次构建时间",width:"160"}}),e._v(" "),a("el-table-column",{attrs:{prop:"operation",label:"操作",width:"220"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-button",{attrs:{type:"primary"},on:{click:function(a){return e.publish(t.row.id)}}},[e._v("构建")]),e._v(" "),a("el-button",{attrs:{type:"success"},on:{click:function(a){return e.handleDetail(t.row)}}},[e._v("详情")]),e._v(" "),a("el-button",{attrs:{type:"danger"},on:{click:function(a){return e.handleRollback(t.row.id)}}},[e._v("回滚")])]}}])})],1),e._v(" "),a("el-dialog",{attrs:{title:"构建记录",visible:e.dialogVisible},on:{"update:visible":function(t){e.dialogVisible=t}}},[a("el-row",[a("el-col",{attrs:{span:8}},[a("el-radio-group",{on:{change:e.handleDetailChange},model:{value:e.publishToken,callback:function(t){e.publishToken=t},expression:"publishToken"}},e._l(e.gitTraceList,function(t,o){return a("el-row",{key:o},[a("el-row",{staticStyle:{margin:"5px 0"}},[1===t.publishState?a("el-tag",{attrs:{type:"success",effect:"plain"}},[e._v("成功")]):a("el-tag",{attrs:{type:"danger",effect:"plain"}},[e._v("失败")]),e._v(" "),a("el-radio",{staticStyle:{"margin-left":"10px","margin-right":"5px"},attrs:{label:t.token,border:""}},[e._v("commitID: "+e._s(t.commit))]),e._v(" "),a("el-button",{attrs:{type:"danger",icon:"el-icon-refresh",plain:""},on:{click:function(a){return e.rollback(t)}}})],1)],1)}),1)],1),e._v(" "),a("el-col",{staticClass:"project-detail",attrs:{span:16}},[e._l(e.publishLocalTraceList,function(t,o){return a("el-row",{key:o},[2===t.type?a("el-row",[a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("git同步信息")]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("时间: "+e._s(t.createTime))]),e._v(" "),a("el-row",[e._v("commit: "+e._s(t.commit))]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[0===t.state?a("el-tag",{attrs:{type:"danger",effect:"plain"}},[e._v("失败")]):e._e(),e._v(" "),a("span",{domProps:{innerHTML:e._s(e.formatDetail(t.detail))}})],1)],1):e._e(),e._v(" "),3===t.type?a("el-row",[a("hr"),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("获取代码后脚本信息")]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("时间: "+e._s(t.createTime))]),e._v(" "),a("el-row",[e._v("脚本: "),a("pre",{domProps:{innerHTML:e._s(e.formatDetail(t.script))}})]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[0===t.state?a("el-tag",{attrs:{type:"danger",effect:"plain"}},[e._v("失败")]):e._e(),e._v(" "),a("el-row",[e._v("[goploy ~]# "),a("span",{domProps:{innerHTML:e._s(e.formatDetail(t.detail))}})])],1)],1):e._e(),e._v(" "),6===t.type?a("el-row",[a("hr"),e._v(" "),a("el-row",[a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("remote服务器信息")]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("服务器: "+e._s(t.serverName))]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("时间: "+e._s(t.createTime))]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("脚本: "+e._s(t.script))]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[0===t.state?a("el-tag",{attrs:{type:"danger",effect:"plain"}},[e._v("失败")]):e._e(),e._v(" "),a("span",{domProps:{innerHTML:e._s(e.formatDetail(t.detail))}})],1)],1)],1):e._e()],1)}),e._v(" "),a("hr"),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("目标服务器")]),e._v(" "),a("el-tabs",{model:{value:e.activeRomoteTracePane,callback:function(t){e.activeRomoteTracePane=t},expression:"activeRomoteTracePane"}},e._l(e.publishRemoteTraceList,function(t,o){return a("el-tab-pane",{key:o,attrs:{label:o,name:o}},e._l(t,function(t,o){return a("el-row",{key:o},[4===t.type?a("el-row",[a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("部署前脚本")]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("时间: "+e._s(t.createTime))]),e._v(" "),a("el-row",[e._v("脚本: "),a("pre",{domProps:{innerHTML:e._s(e.formatDetail(t.script))}})]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[0===t.state?a("el-tag",{attrs:{type:"danger",effect:"plain"}},[e._v("失败")]):e._e(),e._v(" "),a("el-row",[e._v("[goploy ~]# "),a("span",{domProps:{innerHTML:e._s(e.formatDetail(t.detail))}})])],1)],1):5===t.type?a("el-row",[a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("rsync同步文件")]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("时间: "+e._s(t.createTime))]),e._v(" "),a("el-row",[e._v("命令: "+e._s(t.command))]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[0===t.state?a("el-tag",{attrs:{type:"danger",effect:"plain"}},[e._v("失败")]):e._e(),e._v(" "),a("span",{domProps:{innerHTML:e._s(e.formatDetail(t.detail))}})],1)],1):a("el-row",[a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("部署后脚本")]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("时间: "+e._s(t.createTime))]),e._v(" "),a("el-row",[e._v("脚本: "),a("pre",{domProps:{innerHTML:e._s(e.formatDetail(t.script))}})]),e._v(" "),a("el-row",{staticStyle:{margin:"5px 0"}},[0===t.state?a("el-tag",{attrs:{type:"danger",effect:"plain"}},[e._v("失败")]):e._e(),e._v(" "),a("el-row",[e._v("[goploy ~]# "),a("span",{domProps:{innerHTML:e._s(e.formatDetail(t.detail))}})])],1)],1)],1)}),1)}),1)],2)],1),e._v(" "),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{on:{click:function(t){e.dialogVisible=!1}}},[e._v("取 消")])],1)],1),e._v(" "),a("el-dialog",{attrs:{title:"构建进度",visible:e.publishDialogVisible},on:{"update:visible":function(t){e.publishDialogVisible=t}}},[a("el-row",{ref:"publishSchedule",staticClass:"project-detail"},[a("el-row",[a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("git同步信息")]),e._v(" "),e._l(e.gitLog,function(t,o){return a("el-row",{key:o},[a("el-row",{staticStyle:{margin:"5px 0"}},[a("el-tag",{directives:[{name:"show",rawName:"v-show",value:0===t["state"],expression:"item['state'] === 0"}],attrs:{type:"danger",effect:"plain"}},[e._v("失败")]),e._v(" "),a("span",{domProps:{innerHTML:e._s(t["message"])}})],1)],1)})],2),e._v(" "),a("hr"),e._v(" "),a("el-row",[a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("remote服务器信息")]),e._v(" "),e._l(e.remoteLog,function(t,o){return a("el-row",{key:o},[a("el-row",{staticStyle:{margin:"5px 0"}},[e._v("服务器: "+e._s(o))]),e._v(" "),e._l(t,function(t,o){return a("el-row",{key:o},[a("el-row",{staticStyle:{margin:"5px 0"}},[a("el-tag",{directives:[{name:"show",rawName:"v-show",value:0===t["state"],expression:"item['state'] === 0"}],attrs:{type:"danger",effect:"plain"}},[e._v("失败")]),e._v(" "),a("span",{domProps:{innerHTML:e._s(t["message"])}})],1)],1)}),e._v(" "),a("hr")],2)})],2)],1)],1),e._v(" "),a("el-dialog",{attrs:{title:"commit管理",visible:e.commitDialogVisible},on:{"update:visible":function(t){e.commitDialogVisible=t}}},[a("el-table",{attrs:{border:"",stripe:"","highlight-current-row":"",data:e.commitTableData}},[a("el-table-column",{attrs:{prop:"commit",label:"commit",width:"290"}}),e._v(" "),a("el-table-column",{attrs:{prop:"author",label:"author"}}),e._v(" "),a("el-table-column",{attrs:{prop:"date",label:"date"}}),e._v(" "),a("el-table-column",{attrs:{prop:"message",label:"message"}}),e._v(" "),a("el-table-column",{attrs:{prop:"operation",label:"操作",width:"75"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-button",{attrs:{type:"danger"},on:{click:function(a){return e.rollback(t.row)}}},[e._v("构建")])]}}])})],1),e._v(" "),a("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{on:{click:function(t){e.commitDialogVisible=!1}}},[e._v("取 消")])],1)],1)],1)},r=[],i=(a("a481"),a("7f7f"),a("7514"),a("28a5"),a("ac4d"),a("8a81"),a("456d"),a("ac6a"),a("b775"));function n(e,t){return Object(i["a"])({url:"/deploy/getList",method:"get",params:{groupId:e,projectName:t}})}function l(e){return Object(i["a"])({url:"/deploy/getDetail",method:"get",params:{lastPublishToken:e}})}function s(e){return Object(i["a"])({url:"/deploy/getPreview",method:"get",params:{projectId:e}})}function c(e){return Object(i["a"])({url:"/deploy/getCommitList",method:"get",params:{id:e}})}function u(e){return Object(i["a"])({url:"/deploy/publish",method:"post",data:{projectId:e}})}function p(e,t){return Object(i["a"])({url:"/deploy/rollback",method:"post",data:{projectId:e,commit:t}})}var m=a("23ba"),g=a("ed08"),d={data:function(){return{groupId:parseInt(localStorage.getItem("groupId"))||0,groupOption:[],projectName:"",publishToken:"",publishDialogVisible:!1,commitDialogVisible:!1,dialogVisible:!1,webSocket:null,tableData:[],commitTableData:[],gitTraceList:[],publishTraceList:[],publishLocalTraceList:[],publishRemoteTraceList:{},activeRomoteTracePane:"",gitLog:[],remoteLog:{}}},created:function(){var e=this;this.getList(),this.getGroupOption(),this.$router.afterEach(function(){e.webSocket&&e.webSocket.close()})},methods:{connectWebSocket:function(){var e=this;return this.webSocket&&this.webSocket.readyState<2?(console.log("reusing the socket connection [state = "+this.webSocket.readyState+"]: "+this.webSocket.url),Promise.resolve(this.webSocket)):new Promise(function(t,a){e.webSocket=new WebSocket("ws://"+window.location.host+"/ws/unicast"),e.webSocket.onopen=function(){console.log("socket connection is opened [state = "+e.webSocket.readyState+"]: "+e.webSocket.url),t(e.webSocket)},e.webSocket.onerror=function(e){console.error("socket connection error : ",e),a(e)},e.webSocket.onclose=function(t){e.webSocket=null,console.log("connection closed ("+t.code+")")},e.webSocket.onmessage=function(t){var a=JSON.parse(t.data);a.message=e.formatDetail(a.message),1===a.dataType?e.gitLog.push(a):(e.remoteLog[a.serverName]||e.$set(e.remoteLog,a.serverName,[]),e.remoteLog[a.serverName].push(a)),e.$nextTick(function(){var t=e.$refs.publishSchedule;t.$el.scrollTop=t.$el.scrollHeight})}})},handleGroupChange:function(e){localStorage.setItem("groupId",e),this.groupId=e,this.getList()},getGroupOption:function(){var e=this;Object(m["d"])().then(function(t){e.groupOption=t.data.groupList||[]})},getList:function(){var e=this;n(this.groupId,this.projectName).then(function(t){var a=t.data.projectList||[];a.forEach(function(e){e.createTime=Object(g["b"])(e.createTime),e.updateTime=Object(g["b"])(e.updateTime)}),e.tableData=a})},publish:function(e){var t=this;this.$confirm("此操作将部署该项目, 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){t.gitLog=[],t.remoteLog={},t.publishDialogVisible=!0,t.connectWebSocket().then(function(a){u(e).then(function(e){setTimeout(function(){t.getList()},1e3)})})}).catch(function(){t.$message({type:"info",message:"已取消构建"})})},getDetail:function(){var e=this;l(this.publishToken).then(function(t){var a=t.data.publishTraceList||[];e.publishTraceList=a.map(function(e){return e.createTime=Object(g["b"])(e.createTime),""!==e.ext&&Object.assign(e,JSON.parse(e.ext)),e}),e.publishLocalTraceList=e.publishTraceList.filter(function(e){return e.type<4}),e.publishRemoteTraceList={};var o=!0,r=!1,i=void 0;try{for(var n,l=e.publishTraceList[Symbol.iterator]();!(o=(n=l.next()).done);o=!0){var s=n.value;s.type<4||(e.publishRemoteTraceList[s.serverName]||(e.publishRemoteTraceList[s.serverName]=[]),e.publishRemoteTraceList[s.serverName].push(s))}}catch(c){r=!0,i=c}finally{try{o||null==l.return||l.return()}finally{if(r)throw i}}e.activeRomoteTracePane=Object.keys(e.publishRemoteTraceList)[0]})},handleDetail:function(e){var t=this;this.dialogVisible=!0,this.publishToken=e.lastPublishToken,s(e.id).then(function(e){var a=e.data.gitTraceList||[];t.gitTraceList=a.map(function(e){return""!==e.ext&&Object.assign(e,JSON.parse(e.ext)),e.commit=e["commit"]?e["commit"].substring(0,6):"",e})}),this.getDetail()},handleDetailChange:function(e){this.publishToken=e,this.getDetail()},handleRollback:function(e){var t=this;c(e).then(function(a){t.commitTableData=a.data.commitList.map(function(t){var a=t.split("`");return{projectId:e,commit:a[0],author:a[1],date:a[2],message:a[3]}}),t.commitDialogVisible=!0})},rollback:function(e){var t=this;this.$confirm("此操作将重新构建"+e.commit+", 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){t.gitLog=[],t.remoteLog={},t.dialogVisible=!1,t.publishDialogVisible=!0,t.connectWebSocket().then(function(a){p(e.projectId,e.commit).then(function(e){t.$message({message:e.message,type:"success",duration:5e3}),setTimeout(function(){t.getList()},1e3)})})}).catch(function(){t.$message({type:"info",message:"已取消重新构建"})})},findGroupName:function(e){var t=this.groupOption.find(function(t){return t.id===e});return t?t["name"]:"默认"},formatDetail:function(e){return e?e.replace(/\n|(\r\n)/g,"<br>"):""}}},b=d,v=(a("3ea3"),a("2877")),f=Object(v["a"])(b,o,r,!1,null,"70c32226",null);t["default"]=f.exports},e21b:function(e,t,a){},ed08:function(e,t,a){"use strict";a.d(t,"b",function(){return r}),a.d(t,"a",function(){return i});a("ac6a"),a("c5f6"),a("28a5"),a("a481"),a("6b54");var o=a("7618");function r(e,t){if(0===arguments.length)return null;var a,r=t||"{y}-{m}-{d} {h}:{i}:{s}";"object"===Object(o["a"])(e)?a=e:("string"===typeof e&&/^[0-9]+$/.test(e)&&(e=parseInt(e)),"number"===typeof e&&10===e.toString().length&&(e*=1e3),a=new Date(e));var i={y:a.getFullYear(),m:a.getMonth()+1,d:a.getDate(),h:a.getHours(),i:a.getMinutes(),s:a.getSeconds(),a:a.getDay()},n=r.replace(/{(y|m|d|h|i|s|a)+}/g,function(e,t){var a=i[t];return"a"===t?["日","一","二","三","四","五","六"][a]:(e.length>0&&a<10&&(a="0"+a),a||0)});return n}function i(e){if(0===e)return"0 B";var t=1024,a=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],o=Math.floor(Math.log(e)/Math.log(t));return(e/Math.pow(t,o)).toPrecision(3)+" "+a[o]}}}]);