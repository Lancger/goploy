(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-669417c6"],{"1eca":function(t,e,o){"use strict";var a=o("a48e"),r=o.n(a);r.a},"23ba":function(t,e,o){"use strict";o.d(e,"d",function(){return n}),o.d(e,"e",function(){return i}),o.d(e,"c",function(){return l}),o.d(e,"a",function(){return c}),o.d(e,"b",function(){return s}),o.d(e,"f",function(){return u});var a=o("cebc"),r=o("b775");function n(t){return Object(r["a"])({url:"/group/getList",method:"get",params:Object(a["a"])({},t)})}function i(){return Object(r["a"])({url:"/group/getOption",method:"get"})}function l(){return Object(r["a"])({url:"/group/getDeployOption",method:"get"})}function c(t){return Object(r["a"])({url:"/group/add",method:"post",data:t})}function s(t){return Object(r["a"])({url:"/group/edit",method:"post",data:t})}function u(t){return Object(r["a"])({url:"/group/remove",method:"delete",data:{id:t}})}},"9b7a":function(t,e,o){"use strict";o.r(e);var a=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("el-row",{staticClass:"app-container"},[o("el-row",{staticClass:"app-bar",attrs:{type:"flex"}},[o("el-select",{attrs:{placeholder:"选择分组"},on:{change:t.handleGroupChange},model:{value:t.groupId,callback:function(e){t.groupId=e},expression:"groupId"}},[o("el-option",{attrs:{label:"默认",value:0}}),t._v(" "),t._l(t.groupOption,function(t,e){return o("el-option",{key:e,attrs:{label:t.name,value:t.id}})})],2),t._v(" "),o("el-input",{staticStyle:{width:"300px"},attrs:{placeholder:"请输入项目名称"},on:{change:t.getList},model:{value:t.projectName,callback:function(e){t.projectName=e},expression:"projectName"}})],1),t._v(" "),o("el-table",{staticStyle:{width:"100%","margin-top":"5px"},attrs:{border:"",stripe:"","highlight-current-row":"",data:t.tableData}},[o("el-table-column",{attrs:{prop:"id",label:"ID",width:"60"}}),t._v(" "),o("el-table-column",{attrs:{prop:"name",label:"项目名称","min-width":"160","show-overflow-tooltip":""},scopedSlots:t._u([{key:"default",fn:function(e){return["生产环境"===e.row.environment?o("b",{staticStyle:{color:"#F56C6C"}},[t._v(t._s(e.row.name)+" - "+t._s(e.row.environment))]):"测试环境"===e.row.environment?o("b",{staticStyle:{color:"#E6A23C"}},[t._v(t._s(e.row.name)+" - "+t._s(e.row.environment))]):o("b",{staticStyle:{color:"#909399"}},[t._v(t._s(e.row.name)+" - "+t._s(e.row.environment))])]}}])}),t._v(" "),o("el-table-column",{attrs:{prop:"group",label:"分组"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v("\n        "+t._s(t.findGroupName(e.row.groupId))+"\n      ")]}}])}),t._v(" "),o("el-table-column",{attrs:{prop:"branch",label:"分支"}}),t._v(" "),o("el-table-column",{attrs:{prop:"publisherName",label:"构建者",width:"160"}}),t._v(" "),o("el-table-column",{attrs:{prop:"deployState",label:"构建状态",width:"70"},scopedSlots:t._u([{key:"default",fn:function(e){return[0===e.row.deployState?o("el-tag",{attrs:{type:"info",effect:"plain"}},[t._v("未构建")]):1===e.row.deployState?o("el-tag",{attrs:{type:"warning",effect:"plain"}},[t._v("构建中")]):2===e.row.deployState?o("el-tag",{attrs:{type:"success",effect:"plain"}},[t._v("成功")]):o("el-tag",{attrs:{type:"danger",effect:"plain"}},[t._v("失败")])]}}])}),t._v(" "),o("el-table-column",{attrs:{prop:"updateTime",label:"上次构建时间",width:"160"}}),t._v(" "),o("el-table-column",{attrs:{prop:"operation",label:"操作",width:"175",fixed:"right"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-dropdown",{staticClass:"publish-btn",attrs:{"split-button":"",trigger:"click",disabled:1===e.row.deployState,type:"primary"},on:{click:function(o){return t.publish(e.row)},command:t.handlePublishCommand}},[t._v("\n          构建\n          "),o("el-dropdown-menu",{attrs:{slot:"dropdown"},slot:"dropdown"},[o("el-dropdown-item",{attrs:{command:e.row}},[t._v("选择具体commit")])],1)],1),t._v(" "),o("el-button",{attrs:{type:"success"},on:{click:function(o){return t.handleDetail(e.row)}}},[t._v("详情")])]}}])})],1),t._v(" "),o("el-dialog",{staticClass:"publish-record",attrs:{title:"构建记录",visible:t.dialogVisible},on:{"update:visible":function(e){t.dialogVisible=e}}},[o("el-row",[o("el-col",{attrs:{span:8}},[o("el-radio-group",{on:{change:t.handleDetailChange},model:{value:t.publishToken,callback:function(e){t.publishToken=e},expression:"publishToken"}},t._l(t.gitTraceList,function(e,a){return o("el-row",{key:a},[o("el-row",{staticStyle:{margin:"5px 0"}},[o("el-radio",{staticStyle:{"margin-left":"10px","margin-right":"5px","padding-right":"8px",width:"210px"},attrs:{label:e.token,border:""}},[t._v("\n                "+t._s(e.publisherName)+" commitID: "+t._s(e.commit)+"\n                "),1===e.publishState?o("span",{staticStyle:{color:"#67C23A",float:"right","line-height":"16px"}},[t._v("成功")]):o("span",{staticStyle:{color:"#F56C6C",float:"right","line-height":"16px"}},[t._v("失败")])]),t._v(" "),o("el-button",{attrs:{type:"danger",plain:""},on:{click:function(o){return t.rollback(e)}}},[t._v("rebuild")])],1)],1)}),1)],1),t._v(" "),o("el-col",{staticClass:"project-detail",attrs:{span:16}},[t._l(t.publishLocalTraceList,function(e,a){return o("el-row",{key:a},[2===e.type?o("el-row",[o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("git同步信息")]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("时间: "+t._s(e.createTime))]),t._v(" "),0!==e.state?o("el-row",[o("el-row",[t._v("commit: "+t._s(e["commit"]))]),t._v(" "),o("el-row",[t._v("message: "+t._s(e["message"]))]),t._v(" "),o("el-row",[t._v("author: "+t._s(e["author"]))]),t._v(" "),o("el-row",[t._v("datetime: "+t._s(e["timestamp"]?t.parseTime(e["timestamp"]):""))]),t._v(" "),o("el-row",[o("span",{domProps:{innerHTML:t._s(t.formatDetail(e["diff"]))}})])],1):o("el-row",{staticStyle:{margin:"5px 0"}},[o("el-tag",{attrs:{type:"danger",effect:"plain"}},[t._v("失败")]),t._v(" "),o("span",{domProps:{innerHTML:t._s(t.formatDetail(e.detail))}})],1)],1):t._e(),t._v(" "),3===e.type?o("el-row",[o("hr"),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("获取代码后脚本信息")]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("时间: "+t._s(e.createTime))]),t._v(" "),o("el-row",[t._v("脚本: "),o("pre",{domProps:{innerHTML:t._s(t.formatDetail(e.script))}})]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[0===e.state?o("el-tag",{attrs:{type:"danger",effect:"plain"}},[t._v("失败")]):t._e(),t._v(" "),o("el-row",[t._v("[goploy ~]# "),o("span",{domProps:{innerHTML:t._s(t.formatDetail(e.detail))}})])],1)],1):t._e(),t._v(" "),6===e.type?o("el-row",[o("hr"),t._v(" "),o("el-row",[o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("remote服务器信息")]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("服务器: "+t._s(e.serverName))]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("时间: "+t._s(e.createTime))]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("脚本: "+t._s(e.script))]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[0===e.state?o("el-tag",{attrs:{type:"danger",effect:"plain"}},[t._v("失败")]):t._e(),t._v(" "),o("span",{domProps:{innerHTML:t._s(t.formatDetail(e.detail))}})],1)],1)],1):t._e()],1)}),t._v(" "),o("hr"),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("目标服务器")]),t._v(" "),o("el-tabs",{model:{value:t.activeRomoteTracePane,callback:function(e){t.activeRomoteTracePane=e},expression:"activeRomoteTracePane"}},t._l(t.publishRemoteTraceList,function(e,a){return o("el-tab-pane",{key:a,attrs:{label:a,name:a}},t._l(e,function(e,a){return o("el-row",{key:a},[4===e.type?o("el-row",[o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("部署前脚本")]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("时间: "+t._s(e.createTime))]),t._v(" "),o("el-row",[t._v("脚本: "),o("pre",{domProps:{innerHTML:t._s(t.formatDetail(e.script))}})]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[0===e.state?o("el-tag",{attrs:{type:"danger",effect:"plain"}},[t._v("失败")]):t._e(),t._v(" "),o("el-row",[t._v("[goploy ~]# "),o("span",{domProps:{innerHTML:t._s(t.formatDetail(e.detail))}})])],1)],1):5===e.type?o("el-row",[o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("rsync同步文件")]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("时间: "+t._s(e.createTime))]),t._v(" "),o("el-row",[t._v("命令: "+t._s(e.command))]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[0===e.state?o("el-tag",{attrs:{type:"danger",effect:"plain"}},[t._v("失败")]):t._e(),t._v(" "),o("span",{domProps:{innerHTML:t._s(t.formatDetail(e.detail))}})],1)],1):o("el-row",[o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("部署后脚本")]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[t._v("时间: "+t._s(e.createTime))]),t._v(" "),o("el-row",[t._v("脚本: "+t._s(e.script))]),t._v(" "),o("el-row",{staticStyle:{margin:"5px 0"}},[0===e.state?o("el-tag",{attrs:{type:"danger",effect:"plain"}},[t._v("失败")]):t._e(),t._v(" "),o("el-row",[t._v("[goploy ~]# "),o("span",{domProps:{innerHTML:t._s(t.formatDetail(e.detail))}})])],1)],1)],1)}),1)}),1)],2)],1),t._v(" "),o("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[o("el-button",{on:{click:function(e){t.dialogVisible=!1}}},[t._v("取 消")])],1)],1),t._v(" "),o("el-dialog",{attrs:{title:"commit管理",visible:t.commitDialogVisible},on:{"update:visible":function(e){t.commitDialogVisible=e}}},[o("el-table",{attrs:{border:"",stripe:"","highlight-current-row":"","max-height":"447px",data:t.commitTableData}},[o("el-table-column",{attrs:{type:"expand"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("span",{domProps:{innerHTML:t._s(t.formatDetail(e.row.diff))}})]}}])}),t._v(" "),o("el-table-column",{attrs:{prop:"commit",label:"commit",width:"290"}}),t._v(" "),o("el-table-column",{attrs:{prop:"author",label:"author"}}),t._v(" "),o("el-table-column",{attrs:{label:"提交时间",width:"135"},scopedSlots:t._u([{key:"default",fn:function(e){return[t._v("\n          "+t._s(t.parseTime(e.row.timestamp))+"\n        ")]}}])}),t._v(" "),o("el-table-column",{attrs:{prop:"message",label:"message",width:"200","show-overflow-tooltip":""}}),t._v(" "),o("el-table-column",{attrs:{prop:"operation",label:"操作",width:"80",align:"center",fixed:"right"},scopedSlots:t._u([{key:"default",fn:function(e){return[o("el-button",{attrs:{type:"danger"},on:{click:function(o){return t.rollback(e.row)}}},[t._v("构建")])]}}])})],1),t._v(" "),o("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[o("el-button",{on:{click:function(e){t.commitDialogVisible=!1}}},[t._v("取 消")])],1)],1)],1)},r=[],n=(o("a481"),o("7514"),o("ac4d"),o("8a81"),o("456d"),o("7f7f"),o("ac6a"),o("20d6"),o("b775"));function i(t,e){return Object(n["a"])({url:"/deploy/getList",method:"get",params:{groupId:t,projectName:e}})}function l(t){return Object(n["a"])({url:"/deploy/getDetail",method:"get",params:{lastPublishToken:t}})}function c(t){return Object(n["a"])({url:"/deploy/getPreview",method:"get",params:{projectId:t}})}function s(t){return Object(n["a"])({url:"/deploy/getCommitList",method:"get",params:{id:t}})}function u(t,e){return Object(n["a"])({url:"/deploy/publish",method:"post",data:{projectId:t,commit:e}})}var p=o("23ba"),m=o("ed08"),d={data:function(){return{groupId:parseInt(localStorage.getItem("groupId"))||0,groupOption:[],projectName:"",publishToken:"",commitDialogVisible:!1,dialogVisible:!1,webSocket:null,tableData:[],commitTableData:[],gitTraceList:[],publishTraceList:[],publishLocalTraceList:[],publishRemoteTraceList:{},activeRomoteTracePane:""}},created:function(){var t=this;this.getList(),this.getDeployGroupOption(),this.connectWebSocket(),this.$router.afterEach(function(){t.webSocket&&t.webSocket.close()})},methods:{parseTime:m["c"],connectWebSocket:function(){var t=this;return this.webSocket&&this.webSocket.readyState<2?(console.log("reusing the socket connection [state = "+this.webSocket.readyState+"]: "+this.webSocket.url),Promise.resolve(this.webSocket)):new Promise(function(e,o){t.webSocket=new WebSocket("ws://"+window.location.host+"/ws/broadcast"),t.webSocket.onopen=function(){console.log("socket connection is opened [state = "+t.webSocket.readyState+"]: "+t.webSocket.url),e(t.webSocket)},t.webSocket.onerror=function(t){console.error("socket connection error : ",t),o(t)},t.webSocket.onclose=function(e){t.webSocket=null,console.log("connection closed ("+e.code+")")},t.webSocket.onmessage=function(e){var o=JSON.parse(e.data);console.log(o),o.message=t.formatDetail(o.message),3===o.state&&t.$notify.error({title:o.projectName,dangerouslyUseHTMLString:!0,message:o.message,duration:0});var a=t.tableData.findIndex(function(t){return t.id===o.projectId});-1!==a&&(t.tableData[a].deployState=o.state,t.tableData[a].publisherName=o.username,t.tableData[a].updateTime=Object(m["c"])(new Date))}})},handleGroupChange:function(t){localStorage.setItem("groupId",t),this.groupId=t,this.getList()},getDeployGroupOption:function(){var t=this;Object(p["c"])().then(function(e){t.groupOption=e.data.groupList||[]})},getList:function(){var t=this;i(this.groupId,this.projectName).then(function(e){var o=e.data.projectList||[];o.forEach(function(t){t.createTime=Object(m["c"])(t.createTime),t.updateTime=Object(m["c"])(t.updateTime)}),t.tableData=o})},publish:function(t){var e=this,o=t.id,a=this.$createElement,r="";r="生产环境"===t.environment?"color: #F56C6C":"测试环境"===t.environment?"color: #E6A23C":"color: #909399",this.$confirm("","提示",{message:a("p",null,[a("span",null,"此操作将部署 "+t.name),a("b",{style:r},"("+t.environment+")"),a("span",null,", 是否继续? ")]),confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){e.gitLog=[],e.remoteLog={},e.connectWebSocket().then(function(t){u(o,"").then(function(t){var a=e.tableData.findIndex(function(t){return t.id===o});e.tableData[a].deployState=1})})}).catch(function(){e.$message({type:"info",message:"已取消构建"})})},getDetail:function(){var t=this;l(this.publishToken).then(function(e){var o=e.data.publishTraceList||[];t.publishTraceList=o.map(function(t){return t.createTime=Object(m["c"])(t.createTime),""!==t.ext&&Object.assign(t,JSON.parse(t.ext)),t}),t.publishLocalTraceList=t.publishTraceList.filter(function(t){return t.type<4}),t.publishRemoteTraceList={};var a=!0,r=!1,n=void 0;try{for(var i,l=t.publishTraceList[Symbol.iterator]();!(a=(i=l.next()).done);a=!0){var c=i.value;c.type<4||(t.publishRemoteTraceList[c.serverName]||(t.publishRemoteTraceList[c.serverName]=[]),t.publishRemoteTraceList[c.serverName].push(c))}}catch(s){r=!0,n=s}finally{try{a||null==l.return||l.return()}finally{if(r)throw n}}t.activeRomoteTracePane=Object.keys(t.publishRemoteTraceList)[0]})},handleDetail:function(t){var e=this;this.dialogVisible=!0,c(t.id).then(function(t){var o=t.data.gitTraceList||[];e.gitTraceList=o.map(function(t){return""!==t.ext&&Object.assign(t,JSON.parse(t.ext)),t.commit=t["commit"]?t["commit"].substring(0,6):"",t}),e.gitTraceList.length>0&&(e.publishToken=e.gitTraceList[0].token,e.getDetail())})},handleDetailChange:function(t){this.publishToken=t,this.getDetail()},handlePublishCommand:function(t){var e=this,o=t.id;s(o).then(function(t){e.commitTableData=t.data.commitList.map(function(t){return Object.assign(t,{projectId:o})}),e.commitDialogVisible=!0})},rollback:function(t){var e=this;this.$confirm("此操作将重新构建"+t.commit+", 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){e.connectWebSocket().then(function(o){u(t.projectId,t.commit).then(function(o){var a=e.tableData.findIndex(function(e){return e.id===t.projectId});e.tableData[a].deployState=1,e.commitDialogVisible=!1})})}).catch(function(){e.$message({type:"info",message:"已取消重新构建"})})},findGroupName:function(t){var e=this.groupOption.find(function(e){return e.id===t});return e?e["name"]:"默认"},formatDetail:function(t){return t?t.replace(/\n|(\r\n)/g,"<br>"):""}}},f=d,g=(o("1eca"),o("2877")),b=Object(g["a"])(f,a,r,!1,null,"1216e8ea",null);e["default"]=b.exports},a48e:function(t,e,o){},ed08:function(t,e,o){"use strict";o.d(e,"c",function(){return r}),o.d(e,"b",function(){return n}),o.d(e,"a",function(){return i});o("ac6a"),o("c5f6"),o("28a5"),o("a481"),o("6b54");var a=o("7618");function r(t,e){if(0===arguments.length)return null;var o,r=e||"{y}-{m}-{d} {h}:{i}:{s}";"object"===Object(a["a"])(t)?o=t:("string"===typeof t&&/^[0-9]+$/.test(t)&&(t=parseInt(t)),"number"===typeof t&&10===t.toString().length&&(t*=1e3),o=new Date(t));var n={y:o.getFullYear(),m:o.getMonth()+1,d:o.getDate(),h:o.getHours(),i:o.getMinutes(),s:o.getSeconds(),a:o.getDay()},i=r.replace(/{(y|m|d|h|i|s|a)+}/g,function(t,e){var o=n[e];return"a"===e?["日","一","二","三","四","五","六"][o]:(t.length>0&&o<10&&(o="0"+o),o||0)});return i}function n(t){if(0===t)return"0 B";var e=1024,o=["B","KB","MB","GB","TB","PB","EB","ZB","YB"],a=Math.floor(Math.log(t)/Math.log(e));return(t/Math.pow(e,a)).toPrecision(3)+" "+o[a]}function i(t){var e,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:500;return function(a){var r=this;clearTimeout(e),e=setTimeout(function(){t.call(r,a)},o)}}}}]);